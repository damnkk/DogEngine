#define PI 3.14159265358979
void createCoordinateSystem(in vec3 N, out vec3 Nt, out vec3 Nb)
{
  if(abs(N.x) > abs(N.y))
    Nt = vec3(N.z, 0, -N.x) / sqrt(N.x * N.x + N.z * N.z);
  else
    Nt = vec3(0, -N.z, N.y) / sqrt(N.y * N.y + N.z * N.z);
  Nb = cross(N, Nt);
}

uint tea(uint val0, uint val1)
{
  uint v0 = val0;
  uint v1 = val1;
  uint s0 = 0;

  for(uint n = 0; n < 16; n++)
  {
    s0 += 0x9e3779b9;
    v0 += ((v1 << 4) + 0xa341316c) ^ (v1 + s0) ^ ((v1 >> 5) + 0xc8013ea4);
    v1 += ((v0 << 4) + 0xad90777d) ^ (v0 + s0) ^ ((v0 >> 5) + 0x7e95761e);
  }

  return v0;
}

// Generate a random unsigned int in [0, 2^24) given the previous RNG state
// using the Numerical Recipes linear congruential generator
uint lcg(inout uint prev)
{
  uint LCG_A = 1664525u;
  uint LCG_C = 1013904223u;
  prev       = (LCG_A * prev + LCG_C);
  return prev & 0x00FFFFFF;
}

// Generate a random float in [0, 1) given the previous RNG state
float rnd(inout uint prev)
{
  return (float(lcg(prev)) / float(0x01000000));
}

vec3 samplingHemisphere(inout uint seed, in vec3 x, in vec3 y, in vec3 z)
{


  float r1 = rnd(seed);
  float r2 = rnd(seed);
  float sq = sqrt(r1);

  vec3 direction = vec3(cos(2 * PI * r2) * sq, sin(2 * PI * r2) * sq, sqrt(1. - r1));
  direction      = direction.x * x + direction.y * y + direction.z * z;

  return direction;
}

vec2 toSphericalCoord(vec3 v){
  vec2 uv = vec2(atan(v.z,v.x),asin(v.y));
  uv/=vec2(2.0f*PI,PI);
  uv+=0.5;
  uv.y = 1.0-uv.y;
  return uv;
}

vec3 F(vec3 x)
{
	const float A = 0.22f;
	const float B = 0.30f;
	const float C = 0.10f;
	const float D = 0.20f;
	const float E = 0.01f;
	const float F = 0.30f;
 
	return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;
}

vec3 Uncharted2Tonemap(vec3 x ,float adaptlum) {
  const float WHITE = 11.2f;
	return F(1.6f * adaptlum * x) / F(vec3(WHITE));
}


// const uint V[]= const uint [8*32](
//   2147483648, 1073741824, 536870912, 268435456, 134217728, 67108864, 33554432, 16777216, 8388608, 4194304, 2097152, 1048576, 524288, 262144, 131072, 65536, 32768, 16384, 8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1, 2147483648, 3221225472, 2684354560, 4026531840, 2281701376, 3422552064, 2852126720, 4278190080, 2155872256, 3233808384, 2694840320, 4042260480, 2290614272, 3435921408, 2863267840, 4294901760, 2147516416, 3221274624, 2684395520, 4026593280, 2281736192, 3422604288, 2852170240, 4278255360, 2155905152, 3233857728, 2694881440, 4042322160, 2290649224, 3435973836, 2863311530, 4294967295, 2147483648, 3221225472, 1610612736, 2415919104, 3892314112, 1543503872, 2382364672, 3305111552, 1753219072, 2629828608, 3999268864, 1435500544, 2154299392, 3231449088, 1626210304, 2421489664, 3900735488, 1556135936, 2388680704, 3314585600, 1751705600, 2627492864, 4008611328, 1431684352, 2147543168, 3221249216, 1610649184, 2415969680, 3892340840, 1543543964, 2382425838, 3305133397, 2147483648, 3221225472, 536870912, 1342177280, 4160749568, 1946157056, 2717908992, 2466250752, 3632267264, 624951296, 1507852288, 3872391168, 2013790208, 3020685312, 2181169152, 3271884800, 546275328, 1363623936, 4226424832, 1977167872, 2693105664, 2437829632, 3689389568, 635137280, 1484783744, 3846176960, 2044723232, 3067084880, 2148008184, 3222012020, 537002146, 1342505107, 2147483648, 1073741824, 536870912, 2952790016, 4160749568, 3690987520, 2046820352, 2634022912, 1518338048, 801112064, 2707423232, 4038066176, 3666345984, 1875116032, 2170683392, 1085997056, 579305472, 3016343552, 4217741312, 3719483392, 2013407232, 2617981952, 1510979072, 755882752, 2726789248, 4090085440, 3680870432, 1840435376, 2147625208, 1074478300, 537900666, 2953698205, 2147483648, 1073741824, 1610612736, 805306368, 2818572288, 335544320, 2113929216, 3472883712, 2290089984, 3829399552, 3059744768, 1127219200, 3089629184, 4199809024, 3567124480, 1891565568, 394297344, 3988799488, 920674304, 4193267712, 2950604800, 3977188352, 3250028032, 129093376, 2231568512, 2963678272, 4281226848, 432124720, 803643432, 1633613396, 2672665246, 3170194367, 2147483648, 3221225472, 2684354560, 3489660928, 1476395008, 2483027968, 1040187392, 3808428032, 3196059648, 599785472, 505413632, 4077912064, 1182269440, 1736704000, 2017853440, 2221342720, 3329785856, 2810494976, 3628507136, 1416089600, 2658719744, 864310272, 3863387648, 3076993792, 553150080, 272922560, 4167467040, 1148698640, 1719673080, 2009075780, 2149644390, 3222291575, 2147483648, 1073741824, 2684354560, 1342177280, 2281701376, 1946157056, 436207616, 2566914048, 2625634304, 3208642560, 2720006144, 2098200576, 111673344, 2354315264, 3464626176, 4027383808, 2886631424, 3770826752, 1691164672, 3357462528, 1993345024, 3752330240, 873073152, 2870150400, 1700563072, 87021376, 1097028000, 1222351248, 1560027592, 2977959924, 23268898, 437609937);


//const uint myArray[] = uint[](1u, 2u, 3u, 4u, 5u); 
 const uint sobolMatrix[]=  uint [] (
2147483648,1073741824,536870912,268435456,134217728,67108864,33554432,16777216,8388608,4194304,2097152,1048576,524288,262144,131072,65536,32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1, 
2147483648,3221225472,2684354560,4026531840,2281701376,3422552064,2852126720,4278190080,2155872256,3233808384,2694840320,4042260480,2290614272,3435921408,2863267840,4294901760,2147516416,3221274624,2684395520,4026593280,2281736192,3422604288,2852170240,4278255360,2155905152,3233857728,2694881440,4042322160,2290649224,3435973836,2863311530,4294967295, 
2147483648,1073741824,3758096384,2952790016,1744830464,4093640704,2248146944,1325400064,3900702720,3024093184,1725956096,4289724416,2162688000,1085538304,3764781056,2969501696,1753251840,4097851392,2262884352,1336979456,3907545088,3031757824,1717995008,4294921984,2147510400,1073804352,3758130912,2952810416,1744890088,4093686964,2248173158,1325465599,   
2147483648,3221225472,3758096384,1342177280,939524096,2885681152,1644167168,2466250752,3682598912,4248829952,1524629504,1034944512,3087532032,1812725760,2181955584,3271884800,3817046016,1363853312,954605568,2931372032,1669707776,2437141504,3639324160,4273396480,1535115392,1027604672,3135242464,1840250960,2148007992,3222012076,3759013986,1342505107, 
2147483648,1073741824,2684354560,805306368,2013265920,3422552064,4194304000,2365587456,1484783616,3183476736,559939584,1928331264,3632791552,4257480704,2171207680,1123221504,2693758976,835239936,2070257664,3489386496,4161406976,2349014016,1510454784,3171745536,546275456,1908981824,3680870560,4294692912,2148141176,1073945804,2684860154,806158221,        
2147483648,3221225472,536870912,268435456,1207959552,3959422976,838860800,1493172224,2692743168,3502243840,1746927616,4228907008,2051538944,3052142592,2461138944,2308505600,3355475968,738246656,301998080,1224740864,3900721152,1019276288,1512059392,2769312000,3670581376,1697435840,4203898912,1971977232,2991127112,2582410732,2159194802,3231291801,        
2147483648,1073741824,1610612736,1879048192,4160749568,3154116608,3657433088,2902458368,1518338048,3980394496,987758592,2637168640,3256352768,562823168,415367168,2350972928,1108901888,1636581376,2026004480,4230049792,3122165760,3717004288,2730670592,1361173760,3768066688,818680128,2552398048,3423682608,578871448,289419468,2162202658,1076939793, 
2147483648,3221225472,1610612736,2415919104,1207959552,3825205248,1442840576,721420288,1887436800,473956352,3357540352,607125504,907542528,3139698688,949092352,4168679424,2654306304,255508480,1183064064,2808287232,4034922496,3695184896,2820670976,3023046912,2115503232,1596198464,1855063392,3547923120,4004873992,326812100,2393123970,2203259459, 
2147483648,3221225472,3758096384,3489660928,402653184,2348810240,2986344448,150994944,1971322880,3896508416,2812280832,4050649088,706215936,1157890048,666763264,827785216,3389685760,2500935680,1066000384,3175895040,2014480384,2618641408,1245179392,1427856640,3751283072,1833174208,1612580128,270994832,4161963736,1544898116,2855788890,2233163655, 
2147483648,1073741824,2684354560,2952790016,3623878656,3556769792,2315255808,419430400,864026624,2579496960,1914699776,1024458752,3249012736,3840671744,328597504,1776615424,170557440,1496989696,2475876352,704606208,2854750208,3911975936,1270221312,4260694784,537038208,4027993408,2015684768,1678406032,1378519864,3443150236,3113413922,2164226257,         
2147483648,3221225472,2684354560,268435456,2013265920,1275068416,3791650816,1929379840,3447717888,658505728,3617587200,3631218688,1476919296,2620653568,976617472,790036480,147029536,407879680,4163624960,2351239168,1110345728,1664863232,3049122304,1799491840,897585024,2873100480,2510292000,3144681008,3985115992,4151576244,261489498,2221345463, 
2147483648,1073741824,3758096384,805306368,3892314112,3422552064,1577058304,1627389952,1954545664,163577856,4238344192,3050307584,2862088192,685506560,1747058688,2351890432,3189080064,1361526784,2628820992,3320393728,2727708672,3571926016,3725635072,557396736,2492302976,972769472,345156576,2043032848,4102029768,1237321820,480248874,2245004877, 
2147483648,3221225472,3758096384,1879048192,2818572288,4093640704,1845493760,318767104,494927872,3191865344,3995074560,3543138304,4256694272,3462135808,1175060480,655163392,2476965888,3713581056,1535991808,2573373440,2109212672,240913408,2785676800,1460471552,1000573568,693686080,898459360,2321715504,1614285272,2954627044,1210712290,2218592819,         
2147483648,1073741824,536870912,2415919104,3087007744,2483027968,3254779904,1627389952,2961178624,708837376,786432000,1414529024,2684878848,3489923072,2550267904,67698688,2047574016,4111024128,1921785856,1262882816,2657814528,2115150848,2397761024,2219918592,939524224,3556769856,3791650848,4043309200,142606520,3191865492,3974103234,894435425, 
2147483648,3221225472,1610612736,1342177280,2550136832,2214592512,100663296,3305111552,2759852032,4123000832,1872756736,3920625664,4020764672,700186624,2410545152,2042167296,396853248,4256251904,296214528,951914496,3039668224,3446819840,3666563584,617404160,892184704,225594560,3129692768,1959581520,2905450520,2305969220,3163247206,2982991765, 
2147483648,1073741824,1610612736,3489660928,1476395008,469762048,1241513984,1694498816,3883925504,2755657728,3353346048,363855872,1300758528,1363410944,409337856,2113732608,2557313024,1039515648,4167737344,3992932352,2691037184,4059202560,3932380672,2499791616,233144448,816955456,3389825120,620908752,2273867864,1950827548,2682912330,162569061, 
2147483648,1073741824,3758096384,3489660928,3355443200,335544320,2785017856,4278190080,3229614080,2713714688,870318080,405798912,3722969088,3006529536,1533411328,1039728640,1611300864,2416459776,671670272,3288576000,1846208512,3942951936,1720014336,1589931776,4083345536,3119557696,3993196256,2869784528,2256562248,2395794516,997045830,2918702895,        
2147483648,3221225472,2684354560,2952790016,939524096,738197504,3456106496,486539264,931135488,2436890624,1268776960,3020947456,1403518976,3894149120,94502912,1763115008,3290529792,3377840128,1980588032,4043575296,1501960192,1010893824,1143513600,156321024,3590723712,1090585792,1636344480,272713136,2318276792,341640428,3783959150,3494266285, 
2147483648,1073741824,536870912,805306368,1744830464,2617245696,905969664,3405774848,3984588800,2118123520,1717567488,2958032896,736624640,3188981760,92930048,2722562048,1885634560,1264238592,2926436352,1548840960,1441249280,3642512384,3053731328,2332172544,3447928960,1313248320,241819168,743657776,501514472,1964687580,3893223446,3691081979, 
2147483648,3221225472,536870912,4026531840,2281701376,4227858432,436207616,1090519040,3783262208,3493855232,2044723200,1963982848,3891789824,1530134528,2684485632,805502976,2818605056,201572352,2449612800,3171151872,4219496448,2436957184,2556659200,2773696768,2652497792,774231104,1207541728,1798728912,134217736,1006632972,973078530,2969567247, 
2147483648,1073741824,2684354560,1342177280,134217728,3959422976,1107296256,3271557120,2206203904,583008256,1918894080,2054160384,2544369664,3576430592,397017088,2502754304,3081273344,3308011520,3215499264,691007488,4255754240,3928816640,2116789760,3370940160,206204800,2996674240,2615161120,1739770480,2353688456,4070416068,1004548394,934464117, 
2147483648,3221225472,1610612736,805306368,3355443200,1140850688,3858759680,2969567232,159383552,616562688,3596615680,2022703104,1292369920,3272343552,1711407104,1896022016,1770094592,348176384,509812736,1016139776,2869663744,1913570304,1870800384,1438880512,3219315072,1817256512,1399460896,4288551984,3439853576,51118092,100794374,1090715651, 
2147483648,1073741824,3758096384,4026531840,3892314112,1006632960,1375731712,1761607680,2088763392,3015704576,2564816896,2505048064,2411200512,3393454080,4236378112,4089511936,2028175360,1699987456,1740349440,4131713024,2927839232,2596316160,73560576,3599830784,4284072832,1662428480,557414112,1351060752,4175659016,626245636,2277220366,105181199, 
2147483648,3221225472,536870912,1879048192,402653184,1543503872,2650800128,285212672,2306867200,339738624,2866806784,3408920576,1513619456,335282176,637665280,4244832256,796950528,692174848,2774556672,2456907776,3881465856,3716957184,1599612416,831475968,4183305088,210627776,4141582560,1439694832,1270349832,2612789260,853671938,1462960135, 
2147483648,3221225472,3758096384,2415919104,4160749568,1946157056,570425344,788529152,3095396352,1413480448,1390411776,1204813824,899153920,49020928,1610219520,3514761216,3632365568,71385088,1256218624,2748551168,4019939328,1508731904,3313003008,2856250624,853682560,399576640,765066720,3874391280,2247672200,2323456588,1107425262,2130967033, 
2147483648,1073741824,2684354560,3489660928,1476395008,201326592,973078528,2835349504,3296722944,3477078016,1319108608,254803968,2933391360,2132017152,646053888,708902912,270696448,3111337984,2096717824,3009687552,4244301824,4083655680,1559990784,593853696,83417728,795233472,1056682848,2254776400,4202332168,1227309060,3034275850,1175793677, 
2147483648,1073741824,536870912,2415919104,671088640,1409286144,3992977408,1828716544,3531603968,4148166656,3231711232,1620049920,2982674432,3098279936,2082603008,3134259200,2213052416,3212722176,625647616,921456640,2684434432,3489854464,134441472,3288386816,3321895552,956393024,1015166240,2587921328,304199688,2547037188,1902889474,3627916553, 
2147483648,1073741824,1610612736,268435456,3087007744,872415232,2516582400,2499805184,2793406464,1572864000,983564288,1185939456,231211008,3793485824,1654784000,582025216,1137278976,1394360320,3928023040,3732000768,1240193024,3714978816,2076867072,656189184,471937664,1534201536,1466551584,3031330672,3614169096,4105049092,3077208582,3836520193, 
2147483648,3221225472,3758096384,2952790016,3623878656,2080374784,2449473536,2399141888,1820327936,3661627392,2074083328,3931111424,1644691456,2013003776,1101660160,565116928,1369538560,1766965248,2760433664,4005507072,478881792,3804023808,3062528512,2713490688,2416622720,2298277952,354995872,938244784,1610716296,1879063628,939701422,3422613435,        
2147483648,1073741824,3758096384,1879048192,2550136832,1677721600,3523215360,3573547008,3934257152,549453824,3495952384,149946368,2351431680,781451264,1650589696,3991994368,514555904,441827328,4160774144,1409323008,2852177920,3238171648,2692860416,2445349632,3906996608,4248008640,3066665632,111425872,1042860040,3415643140,4041460238,3643806471, 
2147483648,3221225472,536870912,1342177280,2818572288,603979776,234881024,117440512,2994733056,884998144,1197473792,1387266048,1161297920,3200516096,3753508864,1845952512,3067772928,1807106048,3915390976,3316830208,2142902272,4261792768,1054495232,532111104,1331785600,3870541248,3275285344,3452351184,3409702792,2042987980,1295565666,180642517, 
2147483648,1073741824,536870912,4026531840,671088640,3288334336,1979711488,4244635648,176160768,3074424832,2623537152,3666870272,1864892416,1893466112,1759641600,3838902272,2278064128,3557801984,3475677184,3235778560,1625511936,3503371264,3653765632,3977121024,3014199680,2325646912,4127379104,3171035760,713283592,1195570180,3026233858,512826639      
);



